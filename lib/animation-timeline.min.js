!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.timelineModule=t():e.timelineModule=t()}(window,(function(){return function(e){var t={};function i(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)i.d(n,r,function(t){return e[t]}.bind(null,r));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=10)}([function(e,t){},function(e,t){},function(e,t){},function(e,t){},function(e,t){},function(e,t){},function(e,t){},function(e,t){},function(e,t){},function(e,t){},function(e,t,i){"use strict";function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}i.r(t),i.d(t,"Timeline",(function(){return F})),i.d(t,"TimelineModel",(function(){return H})),i.d(t,"TimelineRow",(function(){return j.TimelineRow})),i.d(t,"TimelineKeyframe",(function(){return N.TimelineKeyframe})),i.d(t,"TimelineEventsEmitter",(function(){return r})),i.d(t,"TimelineOptions",(function(){return u})),i.d(t,"TimelineStyleUtils",(function(){return g})),i.d(t,"TimelineKeyframeStyle",(function(){return I.TimelineKeyframeStyle})),i.d(t,"TimelineRowStyle",(function(){return U.TimelineRowStyle})),i.d(t,"TimelineUtils",(function(){return c})),i.d(t,"TimelineClickableElement",(function(){return Z.TimelineClickableElement})),i.d(t,"Selectable",(function(){return Y.Selectable})),i.d(t,"RowsCalculationsResults",(function(){return G.RowsCalculationsResults})),i.d(t,"RowSize",(function(){return G.RowSize})),i.d(t,"CutBoundsRect",(function(){return X.CutBoundsRect})),i.d(t,"TimelineSelectedEvent",(function(){return q.TimelineSelectedEvent})),i.d(t,"TimelineScrollEvent",(function(){return J.TimelineScrollEvent})),i.d(t,"TimelineClickEvent",(function(){return k})),i.d(t,"TimelineDragEvent",(function(){return R})),i.d(t,"TimelineEvents",(function(){return y})),i.d(t,"TimelineConsts",(function(){return d})),i.d(t,"TimelineKeyframeShape",(function(){return s})),i.d(t,"TimelineInteractionMode",(function(){return m})),i.d(t,"TimelineElementType",(function(){return p})),i.d(t,"TimelineCursorType",(function(){return _})),i.d(t,"TimelineCapShape",(function(){return l}));var r=function(){function e(){var t,i,n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),n=[],(i="_subscriptions")in(t=this)?Object.defineProperty(t,i,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[i]=n}var t,i,r;return t=e,(i=[{key:"on",value:function(e,t){t&&this._subscriptions.push({topic:e,callback:t})}},{key:"off",value:function(e,t){this._subscriptions=this._subscriptions.filter((function(i){return i&&i.callback!=t&&i.topic!=e}))}},{key:"offAll",value:function(){this._subscriptions.length=0}},{key:"emit",value:function(e,t){this._subscriptions.forEach((function(i){i&&i.topic==e&&i.callback&&i.callback(t)}))}}])&&n(t.prototype,i),r&&n(t,r),e}();function o(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var s,l,a=[1,2,5,10],c=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i,n;return t=e,n=[{key:"drawLine",value:function(e,t,i,n,r){e.moveTo(t,i),e.lineTo(n,r)}},{key:"isOverlap",value:function(e,t,i){return!!i&&i.x<=e&&i.x+i.width>=e&&i.y<=t&&i.y+i.height>=t}},{key:"findGoodStep",value:function(t){for(var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=t,r=null,o=e.getPowArgument(t),s=0;s<a.length;s++){var l=a[s],c=l*Math.pow(10,o);if(!i||i%c==0){var h=e.getDistance(t,c);if(0==h||h<=.1&&o>0){r=h,n=c;break}(!r||r>h)&&(r=h,n=c)}}return n}},{key:"isRectOverlap",value:function(e,t){return e&&t?e.x>t.x+t.width||t.x>e.x+e.width||e.y<t.y+t.height||t.y<e.y+e.height:(console.log("Rectangles cannot be empty"),!1)}},{key:"getDistance",value:function(e,t,i,n){return null!=i&&null!=n?Math.sqrt(Math.pow(e-i,2)+Math.pow(t-n,2)):Math.abs(e-t)}},{key:"sign",value:function(e){return e>=0?1:-1}},{key:"clearBrowserSelection",value:function(){if(window)if(window.getSelection)window.getSelection().removeAllRanges();else{var e=window.document;e.selection&&e.selection.empty()}}},{key:"getPowArgument",value:function(e){if(!e||0===e||!isFinite(e))return 1;if(e>=10&&e<100)return 1;if(e>=100&&e<1e3)return 2;if(e>=1e3&&e<1e4)return 3;e=Math.abs(e);var t=0,i=this.sign(e);if(e>1){for(;e>=1;)e=Math.floor(e/10),t++;return i*t-1}return e>0?Math.floor(Math.log(e)/Math.log(10)+1)-1:1}}],(i=null)&&o(t.prototype,i),n&&o(t,n),e}();function h(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}!function(e){e.None="none",e.Rhomb="rhomb",e.Circle="circle",e.Rect="rect"}(s||(s={})),function(e){e.None="none",e.Triangle="triangle",e.Rect="rect"}(l||(l={}));var u=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),h(this,"id",void 0),h(this,"snapsPerSeconds",5),h(this,"snapEnabled",!0),h(this,"snapAllKeyframesOnMove",!1),h(this,"timelineThicknessPx",2),h(this,"timelineMarginTopPx",15),h(this,"timelineCapWidthPx",4),h(this,"timelineCapHeightPx",10),h(this,"timelineCap",l.Rect),h(this,"timelineColor","DarkOrange"),h(this,"stepPx",120),h(this,"stepSmallPx",30),h(this,"smallSteps",50),h(this,"leftMarginPx",25),h(this,"headerFillColor","#101011"),h(this,"fillColor","#101011"),h(this,"labelsColor","#D5D5D5"),h(this,"tickColor","#D5D5D5"),h(this,"selectionColor","White"),h(this,"rowsStyle",{height:24,marginBottom:2,fillColor:"#252526",stripeFillColor:"#094771",stripeHeight:"auto",keyframesStyle:{fillColor:"red",shape:s.Rhomb,selectedFillColor:"DarkOrange",strokeColor:"Black",strokeThickness:.2,draggable:!0}}),h(this,"headerHeight",30),h(this,"ticksFont","11px sans-serif"),h(this,"zoom",1e3),h(this,"zoomSpeed",.1),h(this,"zoomMin",80),h(this,"zoomMax",8e3),h(this,"controlKeyIsMetaKey",!1),h(this,"scrollContainerClass","scroll-container"),h(this,"stripesDraggable",!0),h(this,"keyframesDraggable",!0)};function f(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var _,d=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),f(this,"autoPanSpeed",50),f(this,"scrollByDragSpeed",.12),f(this,"clickDetectionMs",120),f(this,"doubleClickTimeoutMs",400),f(this,"scrollFinishedTimeoutMs",500),f(this,"autoPanByScrollPadding",10),f(this,"clickThreshold",3)};function v(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}!function(e){e.Alias="alias",e.AllScroll="all-scroll",e.Auto="auto",e.Cell="cell",e.ContextMenu="context-menu",e.ColResize="col-resize",e.Copy="copy",e.Crosshair="crosshair",e.Default="default",e.EResize="e-resize",e.EWResize="ew-resize",e.Grab="grab",e.Grabbing="grabbing",e.Help="help",e.Move="move",e.NResize="n-resize",e.NEResize="ne-resize",e.NESWResize="nesw-resize",e.NSResize="ns-resize",e.NWResize="nw-resize",e.NWSEResize="nwse-resize",e.NoDrop="no-drop",e.None="none",e.NotAllowed="not-allowed",e.Pointer="pointer",e.Progress="progress",e.RowResize="row-resize",e.SResize="s-resize",e.SEResize="se-resize",e.SWResize="sw-resize",e.Text="text",e.WResize="w-resize",e.Wait="wait",e.ZoomIn="zoom-in",e.ZoomOut="zoom-out"}(_||(_={}));var p,y,m,g=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i,n;return t=e,n=[{key:"getKeyframeStyle",value:function(e,t,i,n,r){if(e&&e){var o=e;if(void 0!==o[n])return o[n]}if(t&&t.keyframesStyle){var s=t.keyframesStyle;if(void 0!==s[n])return s[n]}if(i&&i.keyframesStyle){var l=i.keyframesStyle;if(void 0!==l[n])return l[n]}return r}},{key:"getRowStyle",value:function(e,t,i,n){if(e){var r=e;if(void 0!==r[i])return r[i]}if(t){var o=t;if(void 0!==o[i])return o[i]}return n}},{key:"getRowHeight",value:function(t,i){return e.getRowStyle(t,i,"height",24)}},{key:"rowStripeHeight",value:function(t,i){return e.getRowStyle(t,i,"stripeHeight","auto")}},{key:"stripeFillColor",value:function(t,i){return e.getRowStyle(t,i,"stripeFillColor")}},{key:"getRowMarginBottom",value:function(t,i){return e.getRowStyle(t,i,"marginBottom",0)}}],(i=null)&&v(t.prototype,i),n&&v(t,n),e}();function x(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function w(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}!function(e){e.Timeline="timeline",e.Keyframe="keyframe",e.Stripe="stripe",e.Row="row"}(p||(p={})),function(e){e.Selected="selected",e.TimeChanged="timechanged",e.DragStarted="dragstarted",e.Drag="drag",e.DragFinished="dragfinished",e.Scroll="scroll",e.DoubleClick="doubleclick",e.MouseDown="mousedown"}(y||(y={})),function(e){e.Selection="selection",e.Pan="pan"}(m||(m={}));var k=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),w(this,"args",void 0),w(this,"pos",void 0),w(this,"val",void 0),w(this,"elements",void 0),w(this,"target",void 0),w(this,"_prevented",!1)}var t,i,n;return t=e,(i=[{key:"preventDefault",value:function(){this._prevented=!0}},{key:"isPrevented",value:function(){return this._prevented}}])&&x(t.prototype,i),n&&x(t,n),e}();function S(e){return(S="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function b(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function P(e,t){return(P=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function C(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var i,n=M(e);if(t){var r=M(this).constructor;i=Reflect.construct(n,arguments,r)}else i=n.apply(this,arguments);return T(this,i)}}function T(e,t){return!t||"object"!==S(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function M(e){return(M=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var R=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&P(e,t)}(i,e);var t=C(i);function i(){return b(this,i),t.apply(this,arguments)}return i}(k);function E(e){return(E="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function D(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function K(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function W(e,t){return(W=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function O(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var i,n=A(e);if(t){var r=A(this).constructor;i=Reflect.construct(n,arguments,r)}else i=n.apply(this,arguments);return z(this,i)}}function z(e,t){return!t||"object"!==E(t)&&"function"!=typeof t?L(e):t}function L(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function V(e,t,i){return(V="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=A(e)););return e}(e,t);if(n){var r=Object.getOwnPropertyDescriptor(n,t);return r.get?r.get.call(i):r.value}})(e,t,i||e)}function A(e){return(A=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function B(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var F=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&W(e,t)}(o,e);var t,i,n,r=O(o);function o(){var e,t,i,n,s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return D(this,o),B(L(n=r.call(this)),"_container",null),B(L(n),"_canvas",null),B(L(n),"_scrollContainer",null),B(L(n),"_scrollContent",null),B(L(n),"_ctx",null),B(L(n),"_options",null),B(L(n),"_startPos",null),B(L(n),"_scrollStartPos",{x:0,y:0}),B(L(n),"_currentPos",null),B(L(n),"_selectionRect",null),B(L(n),"_selectionRectEnabled",!1),B(L(n),"_drag",null),B(L(n),"_startedDragWithCtrl",!1),B(L(n),"_startedDragWithShiftKey",!1),B(L(n),"_clickTimeout",0),B(L(n),"_lastClickTime",0),B(L(n),"_lastClickPoint",null),B(L(n),"_consts",new d),B(L(n),"_clickAllowed",!1),B(L(n),"_scrollFinishedTimerRef",null),B(L(n),"_selectedKeyframes",[]),B(L(n),"_val",0),B(L(n),"_pixelRatio",1),B(L(n),"_currentZoom",0),B(L(n),"_intervalRef",null),B(L(n),"_autoPanLastActionDate",0),B(L(n),"_isPanStarted",!1),B(L(n),"_interactionMode",m.Selection),B(L(n),"_lastUsedArgs",null),B(L(n),"_model",void 0),B(L(n),"_handleBlurEvent",(function(){n._cleanUpSelection()})),B(L(n),"_handleWindowResizeEvent",(function(){n.rescale(),n.redraw()})),B(L(n),"_handleDocumentKeydownEvent",(function(e){if(65===e.which&&n._controlKeyPressed(e))return n._performSelection(!0),e.preventDefault(),!1})),B(L(n),"_handleScrollEvent",(function(t){n._clearScrollFinishedTimer(),n._scrollFinishedTimerRef=setTimeout((function(){n._isPanStarted||(n._scrollFinishedTimerRef&&(clearTimeout(n._scrollFinishedTimerRef),n._scrollFinishedTimerRef=null),n.rescale(),n.redraw())}),n._consts.scrollFinishedTimeoutMs),n.redraw();var i=t||{};i.scrollLeft=n._scrollContainer.scrollLeft,i.scrollTop=n._scrollContainer.scrollTop,i.scrollHeight=n._scrollContainer.scrollHeight,i.scrollWidth=n._scrollContainer.scrollWidth,V((e=L(n),A(o.prototype)),"emit",e).call(e,y.Scroll,i)})),B(L(n),"_handleWheelEvent",(function(e){if(n._controlKeyPressed(e)){if(e.preventDefault(),n._options.zoomSpeed>0&&n._options.zoomSpeed<=1){var t=n._getMousePos(n._canvas,e).x;t<=0&&(t=0);var i=n.pxToVal(n._scrollContainer.scrollLeft+t,!1),r=n._canvas.clientWidth/t,o=c.sign(e.deltaY)*n._options.zoom*n._options.zoomSpeed;n._currentZoom+=o,n._currentZoom>n._options.zoomMax&&(n._currentZoom=n._options.zoomMax),n._currentZoom<n._options.zoomMin&&(n._currentZoom=n._options.zoomMin);var s=n.valToPx(i,!0),l=Math.round(s-n._canvas.clientWidth/r);l<=0&&(l=0),n._rescaleInternal(l+n._canvas.clientWidth,null,"zoom"),n._scrollContainer.scrollLeft!=l&&(n._scrollContainer.scrollLeft=l),n.redraw()}}else n._scrollContainer.scrollTop+=e.deltaY,e.preventDefault()})),B(L(n),"_handleMouseDownEvent",(function(e){var r=Date.now()-n._lastClickTime<n._consts.doubleClickTimeoutMs;if(c.clearBrowserSelection(),n._startPos=n._trackMousePos(n._canvas,e),n._startPos){n._lastClickPoint&&n._startPos&&c.getDistance(n._lastClickPoint.x,n._lastClickPoint.y,n._startPos.x,n._startPos.y)>n._consts.clickThreshold&&(r=!1),n._lastClickPoint=n._startPos,n._scrollStartPos={x:n._scrollContainer.scrollLeft,y:n._scrollContainer.scrollTop},n._clickAllowed=!0;var s=n.elementFromPoint(n._startPos,Math.max(2,n._startPos.radius)),l=n._findDraggable(s,n._startPos.val),a=new k;if(a.pos=n._startPos,a.val=n._startPos.val,a.args=e,a.elements=s,a.target=l,r)V((t=L(n),A(o.prototype)),"emit",t).call(t,y.DoubleClick,a);else if(V((i=L(n),A(o.prototype)),"emit",i).call(i,y.MouseDown,a),n._clickTimeout=Date.now(),n._lastClickTime=Date.now(),a.isPrevented())n._cleanUpSelection();else{if(n._currentPos=n._startPos,l)if(n._drag={changed:!1,target:l,val:l.val,type:l.type,elements:[]},l.type===p.Keyframe)n._startedDragWithCtrl=n._controlKeyPressed(e),n._startedDragWithShiftKey=e.shiftKey,l.keyframe.selected||n._controlKeyPressed(e)||e.shiftKey||n._performSelection(!0,l.keyframe),n._drag.elements=n.getSelectedElements();else if(l.type===p.Stripe){var h=n._drag.target.row.keyframes;n._drag.elements=h&&Array.isArray(h)?h.map((function(e){return n._convertToElement(n._drag.target.row,e)})):[]}else n._drag.elements=[n._drag.target];n.redraw()}}})),B(L(n),"_handleMouseMoveEvent",(function(e){if(e?n._lastUsedArgs=e:e=n._lastUsedArgs,e){var t=e.changedTouches&&e.changedTouches.length>0;if(n._currentPos=n._trackMousePos(n._canvas,e),!n._isPanStarted&&n._selectionRect&&n._clickTimeoutIsOver()&&(n._selectionRectEnabled=!0),e=e,n._startPos)if(1==e.buttons||t){var i=!1;if(n._drag&&!n._startedDragWithCtrl){var r=n._mousePosToVal(n._currentPos.x,!0);if(n._drag.type===p.Timeline)i=n._setTimeInternal(r,"user")||i;else if((n._drag.type==p.Keyframe||n._drag.type==p.Stripe)&&n._drag.elements){var o=Math.floor(r-n._drag.val);Math.abs(o)>0&&(n._drag.elements.forEach((function(e){if(n._options.snapAllKeyframesOnMove){var t=n.snapVal(e.keyframe.val);i=n._setKeyframePos(e.keyframe,t)||i}e.val+o<0&&(o=-e.val)})),Math.abs(o)>0&&n._drag.elements.forEach((function(e){var t=e.keyframe.val+o;(i=n._setKeyframePos(e.keyframe,t)||i)&&(e.val=e.keyframe.val)})),i&&(n._drag.changed||n._emitDragStartedEvent(),n._drag.changed=!0,n._drag.val+=o,n._emitDragEvent()))}}n._interactionMode!==m.Pan||n._drag?n._scrollBySelectionOutOfBounds(n._currentPos):(n._isPanStarted=!0,n._scrollByPan(n._startPos,n._currentPos,n._scrollStartPos)),n.redraw()}else n._cleanUpSelection(),n.redraw();else if(!t){var s=n.elementFromPoint(n._currentPos,Math.max(2,n._currentPos.radius)),l=n._findDraggable(s,n._currentPos.val);if(n._setCursor("default"),l){var a=null;l.type===p.Stripe?a=a||_.EWResize:l.type==p.Keyframe?a=a||_.Pointer:l.type==p.Timeline&&(a=a||_.EWResize),a&&n._setCursor(a)}}t&&e.preventDefault()}})),B(L(n),"_handleMouseUpEvent",(function(e){if(n._startPos){var t=n._trackMousePos(n._canvas,e);n._clickAllowed||!n._clickTimeoutIsOver()||n._drag&&n._startedDragWithCtrl||n._drag&&n._startedDragWithShiftKey?n._performClick(t,e,n._drag):!n._drag&&n._selectionRect&&n._selectionRectEnabled&&n._performSelection(!0,n._selectionRect,e.shiftKey),n._cleanUpSelection(),n.redraw()}})),B(L(n),"_redrawInternal",(function(){n.valToPx(n._val,!0)>n._scrollContainer.scrollWidth&&(n.rescale(),!n._isPanStarted&&n._drag&&n._drag.type!==p.Timeline&&n.scrollLeft()),n._renderBackground(),n._renderRows(),n._renderHeaderBackground(),n._renderTicks(),n._renderKeyframes(),n._renderSelectionRect(),n._renderTimeline()})),(s||l)&&n.initialize(s,l),n}return t=o,(i=[{key:"initialize",value:function(e,t){if(this._model=t,!e||!e.id)throw new Error("Element cannot be empty. Should be string or DOM element.");var i=e.id;if(this._options=this._mergeOptions(e),this._currentZoom=this._options.zoom,i instanceof HTMLElement?this._container=i:this._container=document.getElementById(i),!this._container)throw new Error("Element cannot be empty. Should be string or DOM element.");if(this._scrollContainer=document.createElement("div"),this._scrollContent=document.createElement("div"),this._canvas=document.createElement("canvas"),!this._canvas||!this._canvas.getContext)return console.log("Cannot initialize canvas context."),null;this._container.style.position="relative",this._canvas.style.cssText="image-rendering: -moz-crisp-edges;image-rendering: -webkit-crisp-edges;image-rendering: pixelated;image-rendering: crisp-edges;user-select: none;-webkit-user-select: none;-khtml-user-select: none;-moz-user-select: none;-o-user-select: none;user-select: none;touch-action: none;position: relative;-webkit-user-drag: none;-khtml-user-drag: none;-moz-user-drag: none;-o-user-drag: none;user-drag: none;padding: inherit",this._scrollContainer.classList.add(this._options.scrollContainerClass),this._scrollContainer.style.cssText="overflow: scroll;position: absolute;width:  100%;height:  100%;",this._scrollContent.style.width=this._scrollContent.style.height="100%",this._scrollContainer.appendChild(this._scrollContent),this._container.appendChild(this._scrollContainer);var n=this._scrollContainer.offsetWidth-this._scrollContent.clientWidth;this._canvas.style.width=this._canvas.style.height="calc(100% -"+(n||17)+"px)",this._container.appendChild(this._canvas),this._options.fillColor&&(this._scrollContainer.style.background=this._options.fillColor),this._options.snapsPerSeconds=Math.max(0,Math.min(60,this._options.snapsPerSeconds||0)),this._ctx=this._canvas.getContext("2d"),this._subscribeOnEvents(),this.rescale(),this.redraw()}},{key:"_subscribeOnEvents",value:function(){this._container.addEventListener("wheel",this._handleWheelEvent),this._scrollContainer&&this._scrollContainer.addEventListener("scroll",this._handleScrollEvent),window.addEventListener("blur",this._handleBlurEvent,!1),window.addEventListener("resize",this._handleWindowResizeEvent,!1),document.addEventListener("keydown",this._handleDocumentKeydownEvent,!1),this._canvas.addEventListener("touchstart",this._handleMouseDownEvent,!1),this._canvas.addEventListener("mousedown",this._handleMouseDownEvent,!1),window.addEventListener("mousemove",this._handleMouseMoveEvent,!1),window.addEventListener("touchmove",this._handleMouseMoveEvent,!1),window.addEventListener("mouseup",this._handleMouseUpEvent,!1),window.addEventListener("touchend",this._handleMouseUpEvent,!1)}},{key:"dispose",value:function(){this.offAll(),this._container=null,this._canvas=null,this._scrollContainer=null,this._scrollContent=null,this._ctx=null,this._cleanUpSelection(),this._container.removeEventListener("wheel",this._handleWheelEvent),this._scrollContainer&&this._scrollContainer.removeEventListener("scroll",this._handleScrollEvent),window.removeEventListener("blur",this._handleBlurEvent),window.removeEventListener("resize",this._handleWindowResizeEvent),document.removeEventListener("keydown",this._handleDocumentKeydownEvent),this._canvas.removeEventListener("touchstart",this._handleMouseDownEvent),this._canvas.removeEventListener("mousedown",this._handleMouseDownEvent),window.removeEventListener("mousemove",this._handleMouseMoveEvent),window.removeEventListener("touchmove",this._handleMouseMoveEvent),window.removeEventListener("mouseup",this._handleMouseUpEvent),window.removeEventListener("touchend",this._handleMouseUpEvent),this._stopAutoPan(),this._clearScrollFinishedTimer()}},{key:"_clearScrollFinishedTimer",value:function(){this._scrollFinishedTimerRef&&(clearTimeout(this._scrollFinishedTimerRef),this._scrollFinishedTimerRef=null)}},{key:"_controlKeyPressed",value:function(e){return this._options.controlKeyIsMetaKey||this._options.controlKeyIsMetaKey?e.metaKey:e.ctrlKey}},{key:"_performClick",value:function(e,t,i){var n=!1;if(i&&i.type===p.Keyframe){var r=!0;if((this._startedDragWithCtrl&&this._controlKeyPressed(t)||this._startedDragWithShiftKey&&t.shiftKey)&&this._controlKeyPressed(t)&&(r=!i.target.keyframe.selected),n=this._performSelection(r,this._drag.target.keyframe,this._controlKeyPressed(t)||t.shiftKey)||n,t.shiftKey){var o=this._mousePosToVal(e.x,!0);n=this._setTimeInternal(o,"user")||n}}else n=this._performSelection(!1)||n,n=this._setTimeInternal(this._mousePosToVal(e.x,!0),"user")||n;return n}},{key:"_setKeyframePos",value:function(e,t){return t=Math.floor(t),!(!e||e.val==t||(e.val=t,0))}},{key:"_setCursor",value:function(e){this._canvas.style.cursor!=e&&(this._canvas.style.cursor=e)}},{key:"setInteractionMode",value:function(e){this._interactionMode!=e&&(this._interactionMode=e,this._cleanUpSelection())}},{key:"_convertToElement",value:function(e,t){return{type:p.Keyframe,val:t.val,keyframe:t,row:e}}},{key:"getSelectedElements",value:function(){var e=this,t=[];return this._forEachKeyframe((function(i,n,r){i&&i.selected&&t.push(e._convertToElement(r.row,i))})),t}},{key:"_performSelection",value:function(){var e=this,t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=!1;i||(t||(t=!1),r=t),this._selectedKeyframes.length=0;var o=!0;return this._forEachKeyframe((function(s,l,a){var h=e._getKeyframePosition(s,a);h&&(i&&i===s||c.isOverlap(h.x,h.y,i)?(s.selected!=t&&(s.selected=t,o=!0),s.selected&&e._selectedKeyframes.push(s)):n||s.selected==r||(s.selected=r,o=r))})),o&&this._emitKeyframesSelected(this._selectedKeyframes),o}},{key:"_forEachKeyframe",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._model){var i=this._calculateRowsBounds(t);i&&i.rows.forEach((function(t,i){if(t){var n=t.row;if(n&&n.keyframes&&Array.isArray(n.keyframes)&&!(n.keyframes.length<=0)){var r=!0;n.keyframes.filter((function(e){return e&&!e.hidden})).forEach((function(n,o){e&&n&&e(n,o,t,i,r),r=!1}))}}}))}}},{key:"_trackMousePos",value:function(e,t){var i=this._getMousePos(e,t);if(i.val=this.pxToVal(i.x+this._scrollContainer.scrollLeft),i.snapVal=this.snapVal(i.val),this._startPos){this._selectionRect||(this._selectionRect={});var n=Math.floor(this._startPos.x+(this._scrollStartPos.x-this._scrollContainer.scrollLeft)),r=Math.floor(this._startPos.y+(this._scrollStartPos.y-this._scrollContainer.scrollTop));this._selectionRect.x=Math.min(n,i.x),this._selectionRect.y=Math.min(r,i.y),this._selectionRect.width=Math.max(n,i.x)-this._selectionRect.x,this._selectionRect.height=Math.max(r,i.y)-this._selectionRect.y,this._clickAllowed&&(this._clickAllowed=this._selectionRect.height<=this._consts.clickThreshold&&this._selectionRect.width<=this._consts.clickThreshold)}return i}},{key:"_cleanUpSelection",value:function(){this._emitDragFinishedEvent(),this._startPos=null,this._drag=null,this._startedDragWithCtrl=!1,this._startedDragWithShiftKey=!1,this._selectionRect=null,this._clickTimeout=null,this._scrollStartPos=null,this._isPanStarted=!1,this._clickAllowed=!1,this._stopAutoPan()}},{key:"_clickTimeoutIsOver",value:function(){return!!(this._clickTimeout&&Date.now()-this._clickTimeout>this._consts.clickDetectionMs)}},{key:"_startAutoPan",value:function(){var e=this;this._consts.autoPanSpeed&&(this._intervalRef||(this._intervalRef=setInterval((function(){e._handleMouseMoveEvent(null)}),this._consts.autoPanSpeed)))}},{key:"_stopAutoPan",value:function(){this._intervalRef&&(clearInterval(this._intervalRef),this._intervalRef=null),this._autoPanLastActionDate=null}},{key:"_checkUpdateSpeedTooFast",value:function(){return!!(this._autoPanLastActionDate&&Date.now()-this._autoPanLastActionDate<=10)||(this._autoPanLastActionDate=Date.now(),!1)}},{key:"_scrollByPan",value:function(e,t,i){if(e&&t){var n=Math.round(e.x-t.x),r=i.x+n;n>0&&this._rescaleInternal(r+this._canvas.clientWidth),n>0&&r+this._canvas.clientWidth>=this._scrollContainer.scrollWidth-5?this._scrollContainer.scrollLeft=this._scrollContainer.scrollWidth:this._scrollContainer.scrollLeft=r,this._scrollContainer.scrollTop=Math.round(e.y-t.y)}}},{key:"_scrollBySelectionOutOfBounds",value:function(e){var t=e.x,i=e.y,n=!1,r=0,o=0,s=this._consts.autoPanByScrollPadding,l=t<=s,a=t>=this._canvas.clientWidth-s,h=i<=s,u=i>=this._canvas.clientHeight-s,f=null,_=null;if(l||a||h||u){if(this._startAutoPan(),this._checkUpdateSpeedTooFast())return!1;var d=isNaN(this._consts.scrollByDragSpeed)?1:this._consts.scrollByDragSpeed;l?r=-c.getDistance(t,s)*d:a&&(r=c.getDistance(t,this._canvas.clientWidth-s)*d,f=this._scrollContainer.scrollLeft+this._canvas.clientWidth+r),h?o=-c.getDistance(t,s)*d/4:u&&(o=c.getDistance(t,this._canvas.clientHeight-s)*d/4,_=this._scrollContainer.scrollTop+this._canvas.clientHeight)}else this._stopAutoPan();return(f||_)&&this._rescaleInternal(f,_,"scrollBySelection"),Math.abs(r)>0&&(this._scrollContainer.scrollLeft+=r,n=!0),Math.abs(o)>0&&(this._scrollContainer.scrollTop+=o,n=!0),n}},{key:"pxToVal",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t||(e-=this._options.leftMarginPx);var i=e/this._options.stepPx*this._options.zoom;return i}},{key:"valToPx",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!t){var i=this._scrollContainer.scrollLeft;e-=this.pxToVal(i)}return e*this._options.stepPx/this._options.zoom}},{key:"snapVal",value:function(e){if(this._options.snapsPerSeconds&&this._options.snapEnabled){var t=1e3/this._options.snapsPerSeconds,i=e/t,n=Math.round(i);e=Math.round(n*t)}return e<0&&(e=0),e}},{key:"_mousePosToVal",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=this.pxToVal(this._scrollContainer.scrollLeft+Math.min(e,this._canvas.clientWidth));return i=Math.round(i),t&&(i=this.snapVal(i)),i}},{key:"_formatLineGaugeText",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=e/1e3;t&&(i=e);var n=Math.floor(i/31536e3);i%=31536e3;var r=Math.floor(i/86400);i%=86400;var o=Math.floor(i/3600);i%=3600;var s=Math.floor(i/60);i%=60;var l="";return n&&(l+=n+":"),r&&(l+=r+":"),o&&(l+=o+":"),s&&(l+=s+":"),isNaN(i)||(l+=i),l}},{key:"_renderTicks",value:function(){this._ctx.save();var e=this._scrollContainer.scrollWidth-this._options.leftMarginPx,t=this.pxToVal(0),i=this.pxToVal(e),n=c.getDistance(t,i);if(0!==n){var r=n/(e/this._options.stepPx),o=c.findGoodStep(r);if(0!=o&&!isNaN(o)&&isFinite(o)){var s=o/(e/(n/o)/this._options.stepSmallPx),l=c.findGoodStep(s,o);o%l!=0&&(l=s);var a=this.pxToVal(this._scrollContainer.scrollLeft+this._options.leftMarginPx),h=this.pxToVal(this._scrollContainer.scrollLeft+this._scrollContainer.clientWidth);t=Math.floor(a/o)*o,i=Math.ceil(h/o)*o+o;for(var u=null,f=t;f<=i;f+=o){var _=this.valToPx(f),d=this._getSharp(Math.round(_));this._ctx.save(),this._ctx.beginPath(),this._ctx.setLineDash([4]),this._ctx.lineWidth=1,this._ctx.strokeStyle=this._options.tickColor,c.drawLine(this._ctx,d,(this._options.headerHeight||0)/2,d,this._canvas.clientHeight),this._ctx.stroke(),this._ctx.fillStyle=this._options.labelsColor,this._options.ticksFont&&(this._ctx.font=this._options.ticksFont);var v=this._formatLineGaugeText(f),p=this._ctx.measureText(v),y=d-p.width/2;(isNaN(u)||u<=y)&&(u=y+p.width,this._ctx.fillText(v,y,10)),this._ctx.restore();for(var m=f+l;m<f+o;m+=l){var g=this.valToPx(m),x=this._getSharp(Math.floor(g));this._ctx.beginPath(),this._ctx.lineWidth=this._pixelRatio,this._ctx.strokeStyle=this._options.tickColor,c.drawLine(this._ctx,x,(this._options.headerHeight||0)/1.3,x,this._options.headerHeight),this._ctx.stroke()}}this._ctx.restore()}}}},{key:"_calculateRowsBounds",value:function(){var e=this,t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],i={rows:[],area:{x:0,y:0,width:0,height:0},minValue:null,maxValue:null};if(!this._model)return i;var n=this._model.rows;if(!n||!Array.isArray(n)||n.length<=0)return i;var r=this._options.headerHeight;return n.filter((function(e){return e&&!e.hidden})).forEach((function(n,o){if(n){var s=g.getRowHeight(n,e._options.rowsStyle),l=g.getRowMarginBottom(n,e._options.rowsStyle),a=(r+=s+l)-e._scrollContainer.scrollTop;0==o&&(i.area.y=a),i.area.height=Math.max(r+s,i.area.height);var c={x:0,y:a,width:e._canvas.clientWidth,height:s,marginBottom:l,row:n,index:o,minValue:null,maxValue:null};if(i.rows.push(c),t||n.keyframes&&n.keyframes.forEach&&!(n.keyframes.length<=0)){if(n&&n.keyframes&&n.keyframes.forEach((function(e){var t=e.val;e&&!isNaN(t)&&(c.minValue=null==c.minValue?t:Math.min(t,c.minValue),c.maxValue=null==c.maxValue?t:Math.max(t,c.maxValue))})),!isNaN(c.minValue)&&!isNaN(c.maxValue)){var h=e._getKeyframesStripeSize(n,c.y,c.minValue,c.maxValue);c.stripeRect=h}null!==i.minValue&&null!==c.minValue?i.minValue=Math.min(c.minValue,i.minValue):null!==c.minValue&&(i.minValue=c.minValue),null!==i.maxValue&&null!==c.maxValue?i.maxValue=Math.min(c.maxValue,i.maxValue):null!==c.maxValue&&(i.maxValue=c.maxValue)}}})),null!==i.maxValue&&(i.area.width=this.valToPx(i.maxValue,!0)),i}},{key:"_renderRows",value:function(){var e=this,t=this._calculateRowsBounds();t&&t.rows&&(this._ctx.save(),t.rows.forEach((function(t){if(t){e._ctx.fillStyle=g.getRowStyle(t.row,e._options.rowsStyle,"fillColor","#252526");var i=e._cutBounds(t);i&&e._ctx.fillRect(i.x,i.y,i.width,i.height);var n=g.stripeFillColor(t.row,e._options.rowsStyle);if(!(t.row.keyframes&&t.row.keyframes.length<=1)&&n){var r=e._cutBounds(t.stripeRect);r&&(e._ctx.fillStyle=n,e._ctx.fillRect(r.x,r.y,r.width,r.height))}}})),this._ctx.restore())}},{key:"_cutBounds",value:function(e){if(!e)return null;var t=this._canvas.clientWidth,i=this._options.headerHeight||0,n=this._canvas.clientWidth;if(c.isRectOverlap(e,{x:0,y:i,width:c.getDistance(0,t),height:c.getDistance(i,n)})){var r=Math.max(e.y,i),o=Math.max(e.x,0),s=e.x-o,l=e.y-r;return{height:e.height+l,width:e.width+s,x:o,y:r,overlapY:Math.abs(l)>0,overlapX:Math.abs(s)>0}}return null}},{key:"_getKeyframesStripeSize",value:function(e,t,i,n){var r=g.rowStripeHeight(e,this._options.rowsStyle),o=g.getRowHeight(e,this._options.rowsStyle);(!r&&0!==r||isNaN(r)||"auto"==r)&&(r=Math.floor(.8*o)),r>o&&(r=o);var s=o-r,l=this.valToPx(i),a=this.valToPx(n);return{x:l,y:t+Math.floor(s/2),height:r,width:c.getDistance(l,a)}}},{key:"_getKeyframePosition",value:function(e,t){if(!e)return console.log("keyframe should be defined."),null;var i=e.val;if(isNaN(i))return null;var n,r=t.y+t.height/2;return(n=t.height/3)>0&&!isNaN(i)?{x:Math.floor(this.valToPx(i)),y:Math.floor(r),height:n,width:n}:null}},{key:"_renderKeyframes",value:function(){var e=this;this._forEachKeyframe((function(t,i,n){var r=n.row,o=e._getKeyframePosition(t,n);if(o){var l=e._getSharp(o.x),a=o.y,c=o.height,h=e._cutBounds({x:l-c/2,y:a-c/2,width:c,height:c});if(!h)return;e._ctx.save(),h&&h.overlapY&&(e._ctx.beginPath(),e._ctx.rect(0,e._options.headerHeight||0,e._canvas.clientWidth,e._canvas.clientWidth),e._ctx.clip());var u=g.getKeyframeStyle(t,r,e._options.rowsStyle,"shape",s.Rhomb);if(u===s.None)return;var f=g.getKeyframeStyle(t,r,e._options.rowsStyle,t.selected?"fillColor":"selectedFillColor",t.selected?"red":"DarkOrange"),_=g.getKeyframeStyle(t,r,e._options.rowsStyle,"strokeThickness",.2),d=_>0?g.getKeyframeStyle(t,r,e._options.rowsStyle,"strokeColor","Black"):"";u==s.Rhomb?(e._ctx.beginPath(),e._ctx.translate(l,a),e._ctx.rotate(45*Math.PI/180),_>0&&d&&(e._ctx.fillStyle=d,e._ctx.rect(-c/2,-c/2,c,c),e._ctx.fill()),e._ctx.fillStyle=f,e._ctx.translate(_,_),e._ctx.rect(-c/2,-c/2,c-2*_,c-2*_),e._ctx.fill()):u==s.Circle?(e._ctx.beginPath(),_>0&&d&&(e._ctx.fillStyle=d,e._ctx.arc(l,a,c,0,2*Math.PI)),e._ctx.fillStyle=f,e._ctx.arc(l,a,c-_,0,2*Math.PI),e._ctx.fill()):u==s.Rect&&(e._ctx.beginPath(),a-=c/2,l-=c/2,_>0&&d&&(e._ctx.fillStyle=d,e._ctx.rect(l,a,c,c),e._ctx.fill()),e._ctx.fillStyle=f,e._ctx.rect(l+_,a+_,c-_,c-_),e._ctx.fill()),e._ctx.restore()}}))}},{key:"_renderSelectionRect",value:function(){this._drag||(this._ctx.save(),this._selectionRect&&this._selectionRectEnabled&&(this._ctx.setLineDash([4]),this._ctx.lineWidth=this._pixelRatio,this._ctx.strokeStyle=this._options.selectionColor,this._ctx.strokeRect(this._getSharp(this._selectionRect.x,1),this._getSharp(this._selectionRect.y,1),Math.floor(this._selectionRect.width),Math.floor(this._selectionRect.height))),this._ctx.restore())}},{key:"_renderBackground",value:function(){this._options.fillColor?(this._ctx.save(),this._ctx.beginPath(),this._ctx.rect(0,0,this._canvas.clientWidth,this._canvas.clientHeight),this._ctx.fillStyle=this._options.fillColor,this._ctx.fill(),this._ctx.restore()):this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height)}},{key:"_renderTimeline",value:function(){this._ctx.save();var e=this._options.timelineThicknessPx;this._ctx.lineWidth=e*this._pixelRatio;var t=this._getSharp(Math.round(this.valToPx(this._val)),e);this._ctx.strokeStyle=this._options.timelineColor,this._ctx.fillStyle=this._ctx.strokeStyle;var i=this._options.timelineMarginTopPx;if(this._ctx.beginPath(),c.drawLine(this._ctx,t,i,t,this._canvas.clientHeight),this._ctx.stroke(),this._options.timelineCapWidthPx&&this._options.timelineCapHeightPx){var n=this._options.timelineCapWidthPx,r=this._options.timelineCapHeightPx;this._options.timelineCap===l.Triangle?(this._ctx.beginPath(),this._ctx.moveTo(t-n/2,i),this._ctx.lineTo(t+n/2,i),this._ctx.lineTo(t,r),this._ctx.closePath(),this._ctx.stroke()):this._options.timelineCap===l.Rect&&(this._ctx.fillRect(t-n/2,i,n,r),this._ctx.fill())}this._ctx.restore()}},{key:"_renderHeaderBackground",value:function(){!isNaN(this._options.headerHeight)&&this._options.headerHeight>0&&(this._ctx.save(),this._ctx.lineWidth=this._pixelRatio,this._options.headerFillColor?(this._ctx.lineWidth=this._pixelRatio,this._ctx.fillStyle=this._options.headerFillColor,this._ctx.fillRect(0,0,this._canvas.clientWidth,this._options.headerHeight)):this._ctx.clearRect(0,0,this._canvas.clientWidth,this._options.headerHeight),this._ctx.restore())}},{key:"redraw",value:function(){window.requestAnimationFrame?window.requestAnimationFrame(this._redrawInternal):this._redrawInternal()}},{key:"scrollLeft",value:function(){this._scrollContainer.scrollLeft!=this._scrollContainer.scrollWidth&&(this._scrollContainer.scrollLeft=this._scrollContainer.scrollWidth)}},{key:"getRowByY",value:function(e){var t=this._calculateRowsBounds();if(t&&t.rows)for(var i=0;i<t.rows.length;i++){var n=t.rows[i];if(n&&n.y>=e&&e<=n.y+n.height)return n}return null}},{key:"_getSharp",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return t%2==0?e:e+this._pixelRatio/2}},{key:"getTime",value:function(){return this._val}},{key:"_setTimeInternal",value:function(e,t){return(e=Math.round(e))<0&&(e=0),this._val==e||(this._val=e,this.emit("timeChanged",{val:e,source:t}),!0)}},{key:"setTime",value:function(e){return(!this._drag||this._drag.type!==p.Timeline)&&this._setTimeInternal(e,"setTime")}},{key:"select",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._performSelection(e),this.redraw()}},{key:"getOptions",value:function(){return this._options}},{key:"setScrollLeft",value:function(e){this._scrollContainer&&(this._scrollContainer.scrollLeft=e)}},{key:"setScrollTop",value:function(e){this._scrollContainer&&(this._scrollContainer.scrollTop=e)}},{key:"getScrollLeft",value:function(){return this._scrollContainer?this._scrollContainer.scrollLeft:0}},{key:"getScrollTop",value:function(){return this._scrollContainer?this._scrollContainer.scrollTop:0}},{key:"setOptions",value:function(e){return this._options=this._mergeOptions(e),this.rescale(),this.redraw(),this._options}},{key:"getModel",value:function(){return this._model}},{key:"setModel",value:function(e){this._model=e,this.rescale(),this.redraw()}},{key:"_getMousePos",value:function(e,t){var i=1,n=0,r=0;if(t.changedTouches&&t.changedTouches.length>0){var o=t.changedTouches[0];n=o.clientX,r=o.clientY,i=Math.max(i,o.radiusX,o.radiusY)}else n=t.clientX,r=t.clientY;var s=e.getBoundingClientRect(),l=e.width/this._pixelRatio/s.width,a=e.height/this._pixelRatio/s.height;return{x:(n-s.left)*l,y:(r-s.top)*a,radius:i}}},{key:"_updateCanvasScale",value:function(){var e=!1,t=this._scrollContainer.clientWidth*this._pixelRatio,i=this._scrollContainer.clientHeight*this._pixelRatio;return Math.floor(t)!=Math.floor(this._ctx.canvas.width)&&(this._ctx.canvas.width=t,e=!0),Math.floor(i)!=Math.floor(this._ctx.canvas.height)&&(this._ctx.canvas.height=i,e=!0),e&&this._ctx.setTransform(this._pixelRatio,0,0,this._pixelRatio,0,0),e}},{key:"rescale",value:function(){this._rescaleInternal()}},{key:"_rescaleInternal",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"default";this._updateCanvasScale();var n=this._calculateRowsBounds();if(n&&n.area){var r=this._options.stepPx;e=e||0;var o=this.valToPx(this._val,!0),s=0;o>this._canvas.clientWidth&&(s="scrollBySelection"==i?Math.floor(o+this._canvas.clientWidth+(this._options.stepPx||0)):Math.floor(o+this._canvas.clientWidth/1.5));var l=n.area.width+this._options.leftMarginPx+r;e=Math.max(e,l,this._scrollContainer.scrollLeft+this._canvas.clientWidth,s);var a=Math.floor(e)+"px";a!=this._scrollContent.style.minWidth&&(this._scrollContent.style.minWidth=a);var c=(t=Math.max(Math.floor(n.area.height+.2*this._canvas.clientHeight),this._scrollContainer.scrollTop+this._canvas.clientHeight-1,Math.round(t||0)))+"px";this._scrollContent.style.minHeight!=c&&(this._scrollContent.style.minHeight=c)}}},{key:"_findDraggable",value:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=function(e){return e===p.Timeline?1:e===p.Keyframe?2:e===p.Stripe?3:-1},r=e.filter((function(e){if(e.type===p.Keyframe){var i=!0;if(t._options&&(i=!(void 0!==t._options.keyframesDraggable&&!t._options.keyframesDraggable||void 0!==e.keyframe.draggable&&!e.keyframe.draggable)),!i)return!1}else if(e.type===p.Stripe){var n=!0;if(t._options&&(n=!(void 0!==t._options.stripesDraggable&&!t._options.stripesDraggable||void 0!==e.row.stripeDraggable&&!e.row.stripeDraggable)),!n)return!1}else if(e.type===p.Row)return!1;return!0})),o=r.sort((function(e,t){var r=n(e.type),o=n(t.type);return r!==o||null!==i&&(r=c.getDistance(e.val,i))!==(o=c.getDistance(t.val,i))?r<o?1:-1:0}));return o.length>0?o[o.length-1]:null}},{key:"elementFromPoint",value:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;i=Math.max(i,1);var n=[];if(!e)return n;var r=this.valToPx(this._val),o=Math.max((this._options.timelineThicknessPx||1)*this._pixelRatio,this._options.timelineCapWidthPx*this._pixelRatio||1)+i;return(e.y<=this._options.headerHeight||e.x>=r-o/2&&e.x<=r+o/2)&&n.push({val:this._val,type:p.Timeline}),e.y>=this._options.headerHeight&&this._options.keyframesDraggable&&this._forEachKeyframe((function(r,o,s,l,a){if(a&&s.stripeRect){if(c.isOverlap(e.x,e.y,s)){var h={val:t._mousePosToVal(e.x,!0),type:p.Row,row:s.row};n.push(h)}if(c.isOverlap(e.x,e.y,s.stripeRect)){var u={val:t._mousePosToVal(e.x,!0),type:p.Stripe,row:s.row},f=t.snapVal(s.minValue);u.val+=s.minValue-f,n.push(u)}}var _=t._getKeyframePosition(r,s);_&&c.getDistance(_.x,_.y,e.x,e.y)<=_.height+i&&n.push({keyframe:r,val:r.val,row:s.row,type:p.Keyframe})}),!0),n}},{key:"_mergeOptions",value:function(e){e=e||{};var t=new u;return function e(t,i){if(t&&i)for(var n in t)Object.prototype.hasOwnProperty.call(i,n)&&(null==t[n]?t[n]=i[n]:"object"===E(t[n])&&e(t[n],i[n]))}(t,e),t}},{key:"onDragStarted",value:function(e){this.on(y.DragStarted,e)}},{key:"onDrag",value:function(e){this.on(y.Drag,e)}},{key:"onDragFinished",value:function(e){this.on(y.DragFinished,e)}},{key:"onScroll",value:function(e){this.on(y.Scroll,e)}},{key:"_emitDragStartedEvent",value:function(){var e=this._getDragEventArgs();return this.emit(y.DragStarted,e),e}},{key:"_emitDragFinishedEvent",value:function(){if(this._drag&&this._drag.changed){var e=this._getDragEventArgs();return this.emit(y.DragFinished,e),e}}},{key:"_emitDragEvent",value:function(){if(this._drag){var e=this._getDragEventArgs();return this.emit(y.Drag,{keyframes:this._drag.elements}),e}return null}},{key:"_emitKeyframesSelected",value:function(e){this.emit(y.Selected,{keyframes:e})}},{key:"_getDragEventArgs",value:function(){var e=new R;return this._drag&&(e.val=this._currentPos.val,e.pos=this._currentPos,e.elements=this._drag.elements,e.target=this._drag.target),e}}])&&K(t.prototype,i),n&&K(t,n),o}(r);var H=function e(){var t,i,n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),n=[],(i="rows")in(t=this)?Object.defineProperty(t,i,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[i]=n},j=i(1),N=i(2),I=i(3),U=i(4),Z=i(5),Y=i(6),G=i(0),X=i(7),q=i(8),J=i(9)}])}));